/*********************************************************************  
*                                                                    *
*         Median filter.                                             *
*                  1) using 1x3 and 3x1 window.                      *
*                  2) using 1x5 and 5x1 window.                      *
*                                                                    *
*                                                                    *
*********************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <malloc.h>
#include <graph.h>

typedef unsigned char far* far* image;

enum tag {FALSE,TRUE};
image original;     
image degraded;     
image result;     
image temperal;       
unsigned char o_linedata[256];        /* line data of the original image */
unsigned char d_linedata[256];        /* line data of the degraded image */
unsigned char p_linedata[256];        /* line data of the processed image */
int median[5];                        /* median filter */ 
int median_size;                      /* median filter size ( 3 or 5 ) */
char out_name[20];                    /* name of the output file */


void getname(char *a, char *b)
{
     printf("%s", a);
     scanf("%s",  b);
}

int geti(char *a)
{
     int b;

     printf("%s", a);
     scanf("%d", &b);
     return(b);
}

unsigned char far* far* matuc(unsigned int i, unsigned int j)
{
     unsigned char far* far* m;
     int i1;
   
     m=(unsigned char far* far*)_fmalloc(i*sizeof(unsigned char far*));
     if(!m){
        printf("\n\aUnable to allocate array !!\n");
        exit(0);
     }
     for(i1=0;i1<i;i1++){
        m[i1]=(unsigned char far*)_fmalloc(j*sizeof(unsigned char));
        if(!m[i1]){
           printf("\n\aUnable to allocate array !!\n");
           exit(0);
        }
     }
     return(m);
}

void display(int count)
{
     switch(count%4){
           case 0: printf("\\ %3d)th line processed !!! \\\r", count);
                   break;
           case 1: printf("?%3d)th line processed !!! ?r", count);      
                   break;  /* ascii code 179 */
           case 2: printf("/ %3d)th line processed !!! /\r", count);
                   break;
           case 3: printf("?%3d)th line processed !!! ?r", count);     
                   break;  /* ascii code 196 */
     }
}

/************************************************ 
*                                               *
*     Reading original and degraded image.      *
*                                               *
************************************************/

void read_image()
{
     int i1,i2,datum;
     char in_name1[20],in_name2[20];
     FILE *infile1,*infile2;

     original=matuc(256,256);
     degraded=matuc(256,256);
     result=matuc(256,256);
     temperal=matuc(256,256);
     getname("\nEnter name of the original image : ", in_name1);
     getname("\nEnter name of the degraded image : ", in_name2);
     getname("\nEnter name of the output image : ", out_name);
     if((infile1=fopen(in_name1,"rb"))==NULL){
        puts("\n\aError from reading file !!");
        exit(0);
     }
     puts("\n\nReading original image ...");
     for(i2=0;i2<256;i2++)
        for(i1=0;i1<256;i1++){
           fscanf(infile1,"%c",&original[i1][i2]);
           if(i1==128)  o_linedata[i2]=original[i1][i2];
        }
     if((infile2=fopen(in_name2,"rb"))==NULL){
        puts("\n\aError from reading file !!");
        exit(0);
     }
     puts("\nReading degraded image ...\n");
     for(i2=0;i2<256;i2++)
        for(i1=0;i1<256;i1++){
           fscanf(infile2,"%c",&degraded[i1][i2]);
           if(i1==128)  d_linedata[i2]=degraded[i1][i2];
        }
     fcloseall();
}
     
/*************************************************** 
*                                                  *
*     Median filtering.                            *
*          1. using 1x3 and 3x1 window.            *  
*          2. using 1x5 and 5x1 window.            *
*                                                  *
***************************************************/

void swap(int *p1, int *p2)
{
     int temp;

     temp=*p1;
     *p1=*p2;
     *p2=temp;
}

void sort(int *a)
{
     int i1,i2,pick;

     for(i1=0;i1<median_size-1;i1++){
        pick=i1;
        for(i2=i1+1;i2<median_size;i2++)
           if(a[i2]<a[pick])  pick=i2;
        swap(&a[pick],&a[i1]);
     }
}

void median_filter()
{
     int i1,i2,i11,i22,d1,g;
     unsigned char datum;

     puts("\n\nMedian filtering of the degraded image ...");
     puts("\n\tBeing Carried out along the x-coordinate ...\n");
     for(i2=0;i2<256;i2++){
        for(i1=0;i1<256;i1++){
           if(i2<2)  i22=2;
           else if(i2>253)  i22=253;
           else  i22=i2;
           for(d1=0;d1<median_size;d1++)
              median[d1]=degraded[i1][i22-(median_size-1)/2+d1];
           sort(median);
           g=median[(median_size-1)/2];
           if(g<0)  g=0;
           if(g>255)  g=255;
           temperal[i1][i2]=(unsigned char)g;
        }
        display(i2);
     }
     puts("\n\n\tBeing Carried out along the y-coordinate ...\n");
     for(i2=0;i2<256;i2++){
        for(i1=0;i1<256;i1++){
           if(i1<2)  i11=2;
           else if(i1>253)  i11=253;
           else  i11=i1;
           for(d1=0;d1<median_size;d1++)
              median[d1]=temperal[i11-(median_size-1)/2+d1][i2];
           sort(median);
           g=median[(median_size-1)/2];
           if(g<0)  g=0;
           if(g>255)  g=255;
           result[i1][i2]=(unsigned char)g;
        }
        display(i2);
     }
     fcloseall();    
}

/*********************************************** 
*                                              *
*      Compute Variance for MSE and SNR.       *
*                                              *
***********************************************/

float var_o()
{
     int i1,i2;
     float m,temp,v1;

/* compute the variance of the original image */
     m=0.0;     
     for(i2=3;i2<253;i2++)
        for(i1=3;i1<253;i1++)
           m+=(float)original[i1][i2];
     m/=(250.0*250.0);
     v1=0.0;
     for(i2=3;i2<253;i2++)
        for(i1=3;i1<253;i1++){
           temp=(float)original[i1][i2]-m;
           v1+=pow(temp,2.0);
        }
     v1/=(250.0*250.0);
     return(v1);
}     

float var_e(image a)
{
     int i1,i2;
     float m,temp,v1;

/* compute the variance of a */
     m=0.0;
     for(i2=3;i2<253;i2++)
        for(i1=3;i1<253;i1++)
           m+=(float)(original[i1][i2]-a[i1][i2]);
     m/=(250.0*250.0);
     v1=0.0;
     for(i2=3;i2<253;i2++)
        for(i1=3;i1<253;i1++){
           temp=(float)(original[i1][i2]-a[i1][i2])-m;
           v1+=pow(temp,2.0);
        }
     v1/=(250.0*250.0);
     return(v1);
}

/******************************
*                             *
*        Output file          *
*                             *
******************************/

void out_file()
{
     int i1,i2;
     unsigned char datum;
     FILE *outfile;

     if((outfile=fopen(out_name,"wb"))==NULL){
        printf("\n\n\aFile creation error !!\n");
        exit(0);
     }
     for(i2=0;i2<256;i2++)
        for(i1=0;i1<256;i1++){
           fprintf(outfile,"%c",result[i1][i2]);
           if(i1==128)  p_linedata[i2]=result[i1][i2];
        }
     fcloseall();
}

/************************************* 
*                                    *
*       Drawing error value.         *
*                                    *
*************************************/

void draw_error()
{
     int i1,data;
     static int MAX,MIN;

     _setvideomode(_VRES16COLOR);
     _setbkcolor(15);
     _rectangle(_GBORDER,140,20,630,170);
     _rectangle(_GBORDER,140,215,630,315);
     _rectangle(_GBORDER,140,360,630,460);

     MAX=0;
     MIN=255;
     _setwindow(TRUE,0,0,255,265);
     _setviewport(141,21,629,169);
     _moveto_w(0,0);
     _setcolor(13);
     for(i1=0;i1<256;i1++){
        data=p_linedata[i1];
        MAX=max(data,MAX);
        MIN=min(data,MIN);
        _lineto_w(i1,data);
     }
     _moveto_w(0,MAX);
     _setcolor(9);
     for(i1=0;i1<256;i1+=2)
        _setpixel_w(i1,MAX);
     _moveto_w(0,MIN);
     _setcolor(9);
     for(i1=0;i1<256;i1+=2)
        _setpixel_w(i1,MIN);
     _settextposition(5,3);
     printf("MAX=%3d",MAX);
     _settextposition(8,3);
     printf("MIN=%3d",MIN);
     _settextposition(2,15);
     _outtext("265");
     _settextposition(12,17);
     _outtext("0");
     _settextposition(12,78);
     _outtext("255");
     _settextposition(12,40);
     _outtext("Processed image");

     MAX=0;
     MIN=255;
     _setwindow(TRUE,0,-150,255,150);
     _setviewport(141,216,629,314);
     _moveto_w(0,0);
     _lineto_w(255,0);
     _moveto_w(0,0);
     _setcolor(12);
     for(i1=0;i1<256;i1++){
        data=o_linedata[i1]-p_linedata[i1];
        MAX=max(data,MAX);
        MIN=min(data,MIN);
        _lineto_w(i1,data);
     }
     _moveto_w(0,MAX);
     _setcolor(14);
     for(i1=0;i1<256;i1+=2)
        _setpixel_w(i1,MAX);
     _moveto_w(0,MIN);
     _setcolor(14);
     for(i1=0;i1<256;i1+=2)
        _setpixel_w(i1,MIN);
     _settextposition(16,3);
     printf("MAX=%3d",MAX);
     _settextposition(19,3);
     printf("MIN=%3d",MIN);
     _settextposition(14,15);
     _outtext("150");
     _settextposition(20,14);
     _outtext("-150");
     _settextposition(21,19);
     _outtext("0");
     _settextposition(21,78);
     _outtext("255");
     _settextposition(21,32);
     _outtext("Error value of the proecssed image");
     
     MAX=0;
     MIN=255;
     _setwindow(TRUE,0,-150,255,150);
     _setviewport(141,361,629,459);
     _moveto_w(0,0);
     _lineto_w(255,0);
     _moveto_w(0,0);
     _setcolor(2);
     for(i1=0;i1<256;i1++){
        data=o_linedata[i1]-d_linedata[i1];
        MAX=max(data,MAX);
        MIN=min(data,MIN);
        _lineto_w(i1,data);
     }
     _moveto_w(0,MAX);
     _setcolor(4);
     for(i1=0;i1<256;i1+=2)
        _setpixel_w(i1,MAX);
     _moveto_w(0,MIN);
     _setcolor(4);
     for(i1=0;i1<256;i1+=2)
        _setpixel_w(i1,MIN);
     _settextposition(25,3);
     printf("MAX=%3d",MAX);
     _settextposition(28,3);
     printf("MIN=%3d",MIN);
     _settextposition(23,15);
     _outtext("150");
     _settextposition(29,14);
     _outtext("-150");
     _settextposition(30,19);
     _outtext("0");
     _settextposition(30,78);
     _outtext("255");
     _settextposition(29,32);
     _outtext("Error value of the degraded image");
     getchar();
     getchar();
     _setvideomode(_DEFAULTMODE);
}

/*******************************
*                              *
*        MAIN function         *
*                              *
*******************************/

void main()
{
     int i1,i2,datum,select;
     float v_o,v_d,v_p,nmse_d,nmse_p,snr_d,snr_p,snr_im;                  

     system("cls");
     read_image();
     puts("\n\nChoose the number : ");
     puts("\t1) median filtering ( 1x3 and 3x1 window ).");
     puts("\t2) median filtering ( 1x5 and 5x1 window ).");
     select=geti("\tNumber : ");
     switch(select){
            case 1: median_size=3;
                    median_filter();
                    break;
            case 2: median_size=5;
                    median_filter();
                    break;
           default: exit(0);
     }
     out_file();
     puts("\n\n\nComputing MSE and SNR ...");
     v_o=var_o();
     v_d=var_e(degraded);
     v_p=var_e(result);
     nmse_d=100*(v_d/v_o);
     nmse_p=100*(v_p/v_o);
     snr_d=10*log10(v_o/v_d);
     snr_p=10*log10(v_o/v_p);
     snr_im=10*log10(nmse_d/nmse_p);
     printf("\n\tMSE = %5.2f       ( for degraded image )\n", v_d);
     printf("\n\tMSE = %5.2f       ( for processed image )\n",v_p);
     printf("\n\n\tNMSE = %5.2f %%    ( for degraded image )\n", nmse_d);
     printf("\n\tNMSE = %5.2f %%    ( for processed image )\n",nmse_p);
     printf("\n\n\tSNR = %5.2f dB     ( for degraded image )\n", snr_d);
     printf("\n\tSNR = %5.2f dB     ( for processed image )\n", snr_p);
     printf("\n\n\tSNR improvement = %5.2f dB\n", snr_im);
     puts("\nEnter any key to continue ...\n");
     getchar();
     getchar();
     getchar();
     draw_error();
}