/*=========================================================================
	This program is for converting regular image file to .BMP
	extended file for the use in wordprocessor is DOS environ..
  ========================================================================*/
#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <math.h>

unsigned long sizeWidth,sizeHeight;
unsigned char *regularImage;
unsigned long filesize;
FILE *fi,*fo;

int
findPoint(imageName)
unsigned char imageName[];
{
   int i1,i2;
   for(i1=0;i1<strlen(imageName);i1++)
      if(imageName[i1]=='.')
         i2=i1;
   return i2;
}

void
ReadImage()
{
   long setP,endP,diffP;
   int pointP;
   unsigned char inputName[20],outputName[20];
   printf(" Enter the name of image to be converted to BMP\n");
   printf(" :");
   scanf("%s",inputName);
   if((fi=fopen(inputName,"rb"))==NULL){
      printf("this image is not found...\n");
      exit(-1);
      }
   if(fseek(fi,0L,SEEK_END)){
      printf(" file seek error...\n");
      exit(-1); }
   if((endP=ftell(fi))==-1){
      printf(" file position tell error...\n");
      exit(-1);}
   sizeWidth=(unsigned long)sqrt((double)endP);
   sizeHeight=sizeWidth;
   regularImage=(unsigned char *)calloc(sizeHeight*sizeWidth,sizeof(char));
   fseek(fi,0L,SEEK_SET);
   fread(regularImage,1,sizeHeight*sizeWidth,fi);
   fclose(fi);
   pointP=findPoint(inputName);   
   strcpy(outputName,inputName);
   outputName[pointP+1]='B';
   outputName[pointP+2]='M';
   outputName[pointP+3]='P';
   printf("\n\n *** Image Info ***\n");
   printf(" Name : %s.\n",inputName);
   printf(" Size : %ld * %ld.\n",sizeHeight,sizeWidth);
   printf(" Cnv. : %s -> %s \n",inputName,outputName);
   printf(" -------------------\n\n");
   if((fo=fopen(outputName,"wb"))==NULL){
      printf(" file will not be made...\n");
      exit(-1);
      }
}

void 
BmpCopying()/*already open*/
{
   FILE *infop;
   int nbytes,npxls,i,row,col;
   unsigned long temp1,temp2,temp3,temp4,tempvalue,temp5;    
   unsigned char head[1078];
   printf(" This is BMP File Copying!\n"); 
   if((infop=fopen("head.inf","rb"))==NULL){
      printf(" Info Header open error!!\n");
      printf(" See the file is in this Directory!\n");
      exit(0);
      }
   fread(head,1,1078,infop);
   fclose(infop);
   temp5=(sizeWidth+3)/4;
   temp5*=4;
   filesize=temp5+1078;
   temp4=filesize&0x000000ff;
   temp3=(filesize>>8)&0x000000ff;
   temp2=(filesize>>16)&0x000000ff;
   temp1=filesize>>24;
   head[2]=temp4;
   head[3]=temp3;
   head[4]=temp2;
   head[5]=temp1;
   /*Image Width*/
   tempvalue=sizeWidth;
   temp1=tempvalue>>24;
   temp2=(tempvalue>>16)&0x000000ff;
   temp3=(tempvalue>>8)&0x000000ff;
   temp4=tempvalue&0x000000ff;
   head[18]=temp4;
   head[19]=temp3;
   head[20]=temp2;
   head[21]=temp1;
   /*Image Height*/
   tempvalue=sizeHeight;
   temp1=tempvalue>>24;
   temp2=(tempvalue>>16)&0x000000ff;
   temp3=(tempvalue>>8)&0x000000ff;
   temp4=tempvalue&0x000000ff;
   head[22]=temp4;
   head[23]=temp3;
   head[24]=temp2;
   head[25]=temp1;
   temp5=(sizeWidth+3)/4;
   temp5*=4;
   tempvalue=temp5*sizeHeight;
   temp1=tempvalue>>24;
   temp2=(tempvalue>>16)&0x000000ff;
   temp3=(tempvalue>>8)&0x000000ff;
   temp4=tempvalue&0x000000ff;
   head[34]=temp4;
   head[35]=temp3;
   head[36]=temp2;
   head[37]=temp1;/*Size Image*/
   fwrite(head,1,1078,fo);
   for(row=sizeHeight-1;row>=0;row--){
      nbytes=(npxls+3)/4;
      nbytes*=4;
      fwrite(&regularImage[row*sizeWidth],1,sizeWidth,fo);
      nbytes-=npxls;
      while((nbytes--)>0)
         fputc(0,fo);
      }
   printf(" BMP File ok!\n");
}
int 
main()
{
   ReadImage();
   BmpCopying();
   fclose(fo);
   free(regularImage);
}